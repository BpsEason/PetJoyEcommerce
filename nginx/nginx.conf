# nginx/nginx.conf
# Nginx 配置檔，用於作為 Nuxt 和 Laravel 的反向代理，包含靜態檔案快取。

upstream laravel_backend {
    server laravel:8000;
}

upstream nuxt_frontend {
    server nuxt:3000;
}

server {
    listen 80;
    server_name petjoy.local;
    root /var/www/html/public;

    # Nuxt 前端服務
    location / {
        proxy_pass http://nuxt_frontend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Nuxt 靜態檔案快取
    location /_nuxt/ {
        proxy_pass http://nuxt_frontend;
        expires 1y;
        access_log off;
    }

    # PWA 圖示快取
    location /icons/ {
        proxy_pass http://nuxt_frontend;
        expires 1y;
        access_log off;
    }

    # Laravel 後端 API
    location /api {
        rewrite ^/api(.*)$ /$1 break;
        proxy_pass http://laravel_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}
